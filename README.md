# Nginx
Сопроводительная записка
Цель задачи: Реализация механизма передачи IP-адреса пользователя и всех промежуточных nginx-серверов в заголовке X-Forwarded-For до конечного приложения, обрабатывающего HTTP-запросы. При этом необходимо предотвратить возможность подделки данного заголовка со стороны пользователя.
Решение задачи: Для решения поставленной задачи был разработан тестовый стенд на базе Docker-compose, включающий в себя три сервера nginx и один сервер с приложением на PHP, работающим под управлением Apache.
Конфигурация серверов nginx (nginx1.conf, nginx2.conf, nginx3.conf) и nginx-bal.conf настроена таким образом, чтобы передавать реальный IP-адрес клиента и информацию о промежуточных прокси-серверах в заголовке X-Forwarded-For. Для этого используется директива proxy_set_header, добавляющая к существующему заголовку X-Forwarded-For IP-адрес текущего сервера и его имя, разделенные символом '+'. Также устанавливается заголовок X-Real-IP, в который записывается реальный IP-адрес клиента, если он соответствует доверенному диапазону, определенному в конфигурации1.
На стороне приложения реализован скрипт index.php, который извлекает значения заголовков X-Forwarded-For и X-Real-IP, обрабатывает их и выводит результат. Скрипт удаляет из заголовка X-Forwarded-For все подделанные пользователем IP-адреса, содержащие '+', и выводит очищенный список IP-адресов1.
Docker-compose.yml содержит описание сервисов для запуска nginx-серверов и сервера приложения. Все сервисы объединены в одну сеть nginx-app, что позволяет им взаимодействовать друг с другом2.
Тестирование: Тестирование стенда проводилось путем отправки HTTP-запросов на различные nginx-серверы и анализа ответов от приложения. Проверялось, что приложение корректно выводит IP-адреса всех промежуточных nginx-серверов и клиента, а также что подделка заголовка X-Forwarded-For со стороны клиента не влияет на результат.
Выводы: Разработанный тестовый стенд успешно решает поставленную задачу. Приложение получает корректный заголовок X-Forwarded-For с IP-адресами всех промежуточных nginx-серверов и клиента, а механизмы безопасности предотвращают возможность подделки этого заголовка.

Тестирование с помощью curl

Подмена X-Real-IP на вымышленный

Запрос: curl -i -H "X-Real-IP: 10.47.1.1" http://localhost:8080
Ответ: X-Forwarded-For: 172.18.0.1, 172.18.0.5, 172.18.0.3 
X-Real-IP: 172.18.0.3

Запрос: curl -i -H "X-Real-IP: 10.47.1.1" http://localhost:8081
Ответ: X-Forwarded-For: 172.18.0.1 
X-Real-IP: 172.18.0.1

Запрос: curl -i -H "X-Real-IP: 10.47.1.1" http://localhost:8082
Ответ: X-Forwarded-For: 172.18.0.1, 172.18.0.3 
X-Real-IP: 172.18.0.3

Запрос: curl -i -H "X-Real-IP: 10.47.1.1" http://localhost:8083
Ответ: X-Forwarded-For: 172.18.0.1, 172.18.0.2, 172.18.0.3 
X-Real-IP: 172.18.0.3

Запрос с разрешенного пула адресов с заголовком X-Real-IP


Запрос: curl -i -H "X-Real-IP: 192.168.3.121" http://localhost:8080
Ответ: X-Forwarded-For: 172.18.0.1, 172.18.0.5, 172.18.0.2, 172.18.0.3 X-Real-IP: 192.168.3.121

Запрос: curl -i -H "X-Real-IP: 192.168.3.121" http://localhost:8081
Ответ: X-Forwarded-For: 172.18.0.1 X-Real-IP: 192.168.3.121

Запрос: curl -i -H "X-Real-IP: 192.168.3.121" http://localhost:8082
Ответ: X-Forwarded-For: 172.18.0.1, 172.18.0.3 X-Real-IP: 192.168.3.121

Запрос: curl -i -H "X-Real-IP: 192.168.3.121" http://localhost:8083
Ответ: X-Forwarded-For: 172.18.0.1, 172.18.0.2, 172.18.0.3 X-Real-IP: 192.168.3.121


Тест подмены заголовка X-Forwarded-For


Запрос: curl -i -H "X-Forwarded-For: 45.45.45.45" http://localhost:8080
Ответ: X-Forwarded-For: 172.18.0.1, 172.18.0.5 X-Real-IP: 172.18.0.5

Запрос: curl -i -H "X-Forwarded-For: 45.45.45.45" http://localhost:8081
Ответ: X-Forwarded-For: 172.18.0.1 X-Real-IP: 172.18.0.1

Запрос: curl -i -H "X-Forwarded-For: 45.45.45.45" http://localhost:8082
Ответ: X-Forwarded-For: 172.18.0.1, 172.18.0.3 X-Real-IP: 172.18.0.3

Запрос: curl -i -H "X-Forwarded-For: 45.45.45.45" http://localhost:8083
Ответ: X-Forwarded-For: 172.18.0.1, 172.18.0.2, 172.18.0.3 X-Real-IP: 172.18.0.3

Nginx
